*** LockPatternKeyguardView.smali	2014-10-11 10:20:56.544209186 +1100
--- LockPatternKeyguardView.smali	2014-10-11 10:17:55.384205257 +1100
***************
*** 362,368 ****
      .parameter "x0"
  
      .prologue
!     invoke-direct {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->showAlmostAtAccountLoginDialog()V
  
      return-void
  .end method
--- 381,387 ----
      .parameter "x0"
  
      .prologue
!     invoke-virtual {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->showAlmostAtAccountLoginDialog()V
  
      return-void
  .end method
***************
*** 372,378 ****
      .parameter "x0"
  
      .prologue
!     invoke-direct {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->showTimeoutDialog()V
  
      return-void
  .end method
--- 391,397 ----
      .parameter "x0"
  
      .prologue
!     invoke-virtual {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->showTimeoutDialog()V
  
      return-void
  .end method
***************
*** 528,536 ****
  .end method
  
  .method private getInitialMode()Lcom/android/internal/policy/impl/LockPatternKeyguardView$Mode;
!     .locals 2
  
      .prologue
      iget-object v1, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
  
      invoke-virtual {v1}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState()Lcom/android/internal/telephony/IccCardConstants$State;
--- 547,557 ----
  .end method
  
  .method private getInitialMode()Lcom/android/internal/policy/impl/LockPatternKeyguardView$Mode;
!     .locals 4
  
      .prologue
+     invoke-static {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView$Injector;->updateShowLockBeforeUnlock(Lcom/android/internal/policy/impl/LockPatternKeyguardView;)V
+ 
      iget-object v1, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
  
      invoke-virtual {v1}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState()Lcom/android/internal/telephony/IccCardConstants$State;
***************
*** 538,543 ****
      move-result-object v0
  
      .local v0, simState:Lcom/android/internal/telephony/IccCardConstants$State;
      invoke-direct {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->stuckOnLockScreenBecauseSimMissing()Z
  
      move-result v1
--- 559,573 ----
      move-result-object v0
  
      .local v0, simState:Lcom/android/internal/telephony/IccCardConstants$State;
+     iget-object v1, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
+ 
+     const/4 v3, 0x1
+ 
+     invoke-virtual {v1, v3}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState(I)Lcom/android/internal/telephony/IccCardConstants$State;
+ 
+     move-result-object v2
+ 
+     .local v2, sim2State:Lcom/android/internal/telephony/IccCardConstants$State;
      invoke-direct {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->stuckOnLockScreenBecauseSimMissing()Z
  
      move-result v1
***************
*** 591,596 ****
      .locals 6
  
      .prologue
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
  
      invoke-virtual {v3}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState()Lcom/android/internal/telephony/IccCardConstants$State;
--- 624,632 ----
      .locals 6
  
      .prologue
+     const/4 v5, 0x1
+ 
+     const/4 v4, 0x0
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
  
      invoke-virtual {v3}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState()Lcom/android/internal/telephony/IccCardConstants$State;
***************
*** 598,603 ****
      move-result-object v2
  
      .local v2, simState:Lcom/android/internal/telephony/IccCardConstants$State;
      sget-object v3, Lcom/android/internal/telephony/IccCardConstants$State;->PIN_REQUIRED:Lcom/android/internal/telephony/IccCardConstants$State;
  
      if-ne v2, v3, :cond_0
--- 634,646 ----
      move-result-object v2
  
      .local v2, simState:Lcom/android/internal/telephony/IccCardConstants$State;
+     iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mUpdateMonitor:Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;
+ 
+     invoke-virtual {v3, v5}, Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;->getSimState(I)Lcom/android/internal/telephony/IccCardConstants$State;
+ 
+     move-result-object v1
+ 
+     .local v1, sim2State:Lcom/android/internal/telephony/IccCardConstants$State;
      sget-object v3, Lcom/android/internal/telephony/IccCardConstants$State;->PIN_REQUIRED:Lcom/android/internal/telephony/IccCardConstants$State;
  
      if-ne v2, v3, :cond_0
***************
*** 605,610 ****
      sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPin:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
  
      .local v0, currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      :goto_0
      return-object v0
  
--- 648,655 ----
      sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPin:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
  
      .local v0, currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     iput v4, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mSimIdToUnlock:I
+ 
      :goto_0
      return-object v0
  
***************
*** 617,626 ****
      sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPuk:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
  
      .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      goto :goto_0
  
      .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      :cond_1
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
  
      invoke-virtual {v3}, Lcom/android/internal/widget/LockPatternUtils;->getKeyguardStoredPasswordQuality()I
--- 662,699 ----
      sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPuk:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
  
      .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     iput v4, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mSimIdToUnlock:I
+ 
      goto :goto_0
  
      .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      :cond_1
+     sget-object v3, Lcom/android/internal/telephony/IccCardConstants$State;->PIN_REQUIRED:Lcom/android/internal/telephony/IccCardConstants$State;
+ 
+     if-ne v1, v3, :cond_miui_0
+ 
+     sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPin:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+ 
+     .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     iput v5, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mSimIdToUnlock:I
+ 
+     goto :goto_0
+ 
+     .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     :cond_miui_0
+     sget-object v3, Lcom/android/internal/telephony/IccCardConstants$State;->PUK_REQUIRED:Lcom/android/internal/telephony/IccCardConstants$State;
+ 
+     if-ne v1, v3, :cond_miui_1
+ 
+     sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->SimPuk:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+ 
+     .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     iput v5, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mSimIdToUnlock:I
+ 
+     goto :goto_0
+ 
+     .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
+     :cond_miui_1
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
  
      invoke-virtual {v3}, Lcom/android/internal/widget/LockPatternUtils;->getKeyguardStoredPasswordQuality()I
***************
*** 655,675 ****
      throw v3
  
      :sswitch_0
!     sget-object v0, Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;->Password:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
  
      .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      goto :goto_0
  
      .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      :sswitch_1
-     iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
- 
-     invoke-virtual {v3}, Lcom/android/internal/widget/LockPatternUtils;->isLockPatternEnabled()Z
- 
-     move-result v3
- 
-     if-eqz v3, :cond_4
- 
      iget-boolean v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mForgotPattern:Z
  
      if-nez v3, :cond_2
--- 728,742 ----
      throw v3
  
      :sswitch_0
!     invoke-direct {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->getUnlockModeForHighPasswordQuality()Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
! 
!     move-result-object v0
  
      .restart local v0       #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      goto :goto_0
  
      .end local v0           #currentMode:Lcom/android/internal/policy/impl/LockPatternKeyguardView$UnlockMode;
      :sswitch_1
      iget-boolean v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mForgotPattern:Z
  
      if-nez v3, :cond_2
***************
*** 1032,1037 ****
      .locals 3
  
      .prologue
      iget-object v1, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mBiometricUnlock:Lcom/android/internal/policy/impl/BiometricSensorUnlock;
  
      if-eqz v1, :cond_0
--- 1100,1116 ----
      .locals 3
  
      .prologue
+     invoke-virtual {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->getMode()Lcom/android/internal/policy/impl/LockPatternKeyguardView$Mode;
+ 
+     move-result-object v1
+ 
+     sget-object v2, Lcom/android/internal/policy/impl/LockPatternKeyguardView$Mode;->LockScreen:Lcom/android/internal/policy/impl/LockPatternKeyguardView$Mode;
+ 
+     if-ne v1, v2, :cond_miui_0
+     
+     return-void
+ 
+     :cond_miui_0
      iget-object v1, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mBiometricUnlock:Lcom/android/internal/policy/impl/BiometricSensorUnlock;
  
      if-eqz v1, :cond_0
***************
*** 1099,1104 ****
      .locals 2
  
      .prologue
      iget-object v0, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mLockScreen:Landroid/view/View;
  
      if-eqz v0, :cond_0
--- 1178,1192 ----
      .locals 2
  
      .prologue
+     invoke-static {p0}, Lcom/android/internal/policy/impl/LockPatternKeyguardView$Injector;->needRecreateLockScreen(Lcom/android/internal/policy/impl/LockPatternKeyguardView;)Z
+ 
+     move-result v0
+ 
+     if-nez v0, :cond_miui_0
+ 
+     return-void
+ 
+     :cond_miui_0
      iget-object v0, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mLockScreen:Landroid/view/View;
  
      if-eqz v0, :cond_0
***************
*** 1226,1239 ****
      return-void
  .end method
  
! .method private showAlmostAtAccountLoginDialog()V
      .locals 8
  
      .prologue
      const/16 v2, 0x1e
  
      .local v2, timeoutInSeconds:I
!     const/16 v0, 0xf
  
      .local v0, count:I
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mContext:Landroid/content/Context;
--- 1314,1327 ----
      return-void
  .end method
  
! .method protected showAlmostAtAccountLoginDialog()V
      .locals 8
  
      .prologue
      const/16 v2, 0x1e
  
      .local v2, timeoutInSeconds:I
!     const/16 v0, 0x4
  
      .local v0, count:I
      iget-object v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mContext:Landroid/content/Context;
***************
*** 2065,2070 ****
      .parameter "unlockMode"
  
      .prologue
      const/4 v1, 0x0
  
      .local v1, unlockView:Landroid/view/View;
--- 2290,2297 ----
      .parameter "unlockMode"
  
      .prologue
+     const/4 v8, 0x1
+ 
      const/4 v1, 0x0
  
      .local v1, unlockView:Landroid/view/View;
***************
*** 2091,2106 ****
  
      move-result v6
  
!     invoke-direct/range {v0 .. v6}, Lcom/android/internal/policy/impl/PatternUnlockScreen;-><init>(Landroid/content/Context;Landroid/content/res/Configuration;Lcom/android/internal/widget/LockPatternUtils;Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;Lcom/android/internal/policy/impl/KeyguardScreenCallback;I)V
  
!     .local v0, view:Lcom/android/internal/policy/impl/PatternUnlockScreen;
      iget-boolean v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mEnableFallback:Z
  
!     invoke-virtual {v0, v3}, Lcom/android/internal/policy/impl/PatternUnlockScreen;->setEnableFallback(Z)V
  
      move-object v1, v0
  
!     .end local v0           #view:Lcom/android/internal/policy/impl/PatternUnlockScreen;
      .restart local v1       #unlockView:Landroid/view/View;
      :goto_0
      invoke-direct {p0, v1}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->initializeTransportControlView(Landroid/view/View;)V
--- 2318,2333 ----
  
      move-result v6
  
!     invoke-direct/range {v0 .. v6}, Lcom/android/internal/policy/impl/MiuiPatternUnlockScreen;-><init>(Landroid/content/Context;Landroid/content/res/Configuration;Lcom/android/internal/widget/LockPatternUtils;Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;Lcom/android/internal/policy/impl/KeyguardScreenCallback;I)V
  
!     .local v0, view:Lcom/android/internal/policy/impl/MiuiPatternUnlockScreen;
      iget-boolean v3, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mEnableFallback:Z
  
!     invoke-virtual {v0, v3}, Lcom/android/internal/policy/impl/MiuiPatternUnlockScreen;->setEnableFallback(Z)V
  
      move-object v1, v0
  
!     .end local v0           #view:Lcom/android/internal/policy/impl/MiuiPatternUnlockScreen;
      .restart local v1       #unlockView:Landroid/view/View;
      :goto_0
      invoke-direct {p0, v1}, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->initializeTransportControlView(Landroid/view/View;)V
***************
*** 2235,2243 ****
  
      move-object v3, v1
  
!     invoke-direct/range {v3 .. v8}, Lcom/android/internal/policy/impl/PasswordUnlockScreen;-><init>(Landroid/content/Context;Landroid/content/res/Configuration;Lcom/android/internal/widget/LockPatternUtils;Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;Lcom/android/internal/policy/impl/KeyguardScreenCallback;)V
  
      .restart local v1       #unlockView:Landroid/view/View;
      goto :goto_0
  
      :cond_4
--- 2468,2484 ----
  
      move-object v3, v1
  
!     invoke-direct/range {v3 .. v8}, Lcom/android/internal/policy/impl/MiuiPasswordUnlockScreen;-><init>(Landroid/content/Context;Landroid/content/res/Configuration;Lcom/android/internal/widget/LockPatternUtils;Lcom/android/internal/policy/impl/KeyguardUpdateMonitor;Lcom/android/internal/policy/impl/KeyguardScreenCallback;)V
  
      .restart local v1       #unlockView:Landroid/view/View;
+     move-object v3, v1
+ 
+     check-cast v3, Lcom/android/internal/policy/impl/MiuiPasswordUnlockScreen;
+ 
+     iget-boolean v4, p0, Lcom/android/internal/policy/impl/LockPatternKeyguardView;->mEnableFallback:Z
+ 
+     invoke-virtual {v3, v4}, Lcom/android/internal/policy/impl/MiuiPasswordUnlockScreen;->setEnableFallback(Z)V
+ 
      goto :goto_0
  
      :cond_4
