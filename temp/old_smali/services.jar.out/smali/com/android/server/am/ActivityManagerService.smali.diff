*** ./smali/com/android/server/am/ActivityManagerService.smali	2014-10-11 10:21:23.384209769 +1100
--- /home/cosmicdan/patchrom_mtk/bang/temp/new_smali/services.jar.out/./smali/com/android/server/am/ActivityManagerService.smali	2014-10-11 10:18:22.360205842 +1100
***************
*** 23,29 ****
          Lcom/android/server/am/ActivityManagerService$ProcessChangeItem;,
          Lcom/android/server/am/ActivityManagerService$Identity;,
          Lcom/android/server/am/ActivityManagerService$ForegroundToken;,
!         Lcom/android/server/am/ActivityManagerService$PendingActivityLaunch;
      }
  .end annotation
  
--- 23,30 ----
          Lcom/android/server/am/ActivityManagerService$ProcessChangeItem;,
          Lcom/android/server/am/ActivityManagerService$Identity;,
          Lcom/android/server/am/ActivityManagerService$ForegroundToken;,
!         Lcom/android/server/am/ActivityManagerService$PendingActivityLaunch;,
!         Lcom/android/server/am/ActivityManagerService$Injector;
      }
  .end annotation
  
***************
*** 1764,1769 ****
--- 1765,1772 ----
      .end local v6           #stream:Ljava/io/FileInputStream;
      :cond_1
      :goto_2
+     invoke-static {}, Lcom/android/server/am/ExtraActivityManagerService;->init()V
+ 
      new-instance v8, Lcom/android/server/am/BatteryStatsService;
  
      new-instance v9, Ljava/io/File;
***************
*** 6023,6028 ****
--- 6026,6047 ----
      move-result-object v9
  
      .restart local v9       #queue:Lcom/android/server/am/BroadcastQueue;
+     move-object/from16 v0, p0
+ 
+     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+ 
+     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->getRunningAppProcesses()Ljava/util/List;
+ 
+     move-result-object v6
+ 
+     invoke-virtual/range {v46 .. v46}, Landroid/content/Intent;->getAction()Ljava/lang/String;
+ 
+     move-result-object v10
+ 
+     move-object/from16 v0, v25
+ 
+     invoke-static {v4, v0, v6, v10}, Lcom/android/server/am/ExtraActivityManagerService;->adjustMediaButtonReceivers(Landroid/content/Context;Ljava/util/List;Ljava/util/List;Ljava/lang/String;)V
+ 
      new-instance v8, Lcom/android/server/am/BroadcastRecord;
  
      const/16 v32, 0x0
***************
*** 9327,9337 ****
      const/16 v25, 0x0
  
      .local v25, interesting:Z
!     move-object/from16 v0, p1
  
!     move-object/from16 v1, p5
  
!     if-ne v0, v1, :cond_1b
  
      const/4 v13, 0x0
  
--- 9346,9362 ----
      const/16 v25, 0x0
  
      .local v25, interesting:Z
!     move-object/from16 v0, p0
  
!     move-object/from16 v1, p1
! 
!     move-object/from16 v2, p5
! 
!     invoke-static {v0, v1, v2}, Lcom/android/server/am/ActivityManagerService$Injector;->isForegroundApp(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;Lcom/android/server/am/ProcessRecord;)Z
  
!     move-result v1
! 
!     if-eqz v1, :cond_1b
  
      const/4 v13, 0x0
  
***************
*** 12142,12147 ****
--- 12167,12178 ----
  
      invoke-virtual {v12, v3, v0}, Ljava/util/HashMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
  
+     const-string v3, "crash"
+ 
+     move-object/from16 v0, p2
+ 
+     invoke-virtual {v12, v3, v0}, Ljava/util/HashMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
+ 
      iput-object v12, v15, Landroid/os/Message;->obj:Ljava/lang/Object;
  
      move-object/from16 v0, p0
***************
*** 17061,17066 ****
--- 17092,17099 ----
      .end local v16           #ba:Landroid/util/SparseArray;,"Landroid/util/SparseArray<Ljava/lang/Long;>;"
      .end local v17           #badApps:Ljava/util/Iterator;,"Ljava/util/Iterator<Landroid/util/SparseArray<Ljava/lang/Long;>;>;"
      :cond_9
+     invoke-direct/range {p0 .. p1}, Lcom/android/server/am/ActivityManagerService;->killNativePackageProcesses(Ljava/lang/String;)V
+ 
      const/16 v8, -0x64
  
      const/4 v10, 0x0
***************
*** 21087,21092 ****
--- 21120,21171 ----
      goto :goto_0
  .end method
  
+ .method private final killNativePackageProcesses(Ljava/lang/String;)V
+     .locals 3
+     .parameter "packageName"
+ 
+     .prologue
+     :try_start_0
+     iget-object v1, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+ 
+     const-string v2, "security"
+ 
+     invoke-virtual {v1, v2}, Landroid/content/Context;->getSystemService(Ljava/lang/String;)Ljava/lang/Object;
+ 
+     move-result-object v0
+ 
+     check-cast v0, Lmiui/security/SecurityManager;
+ 
+     .local v0, sm:Lmiui/security/SecurityManager;
+     if-eqz v0, :cond_0
+ 
+     if-eqz p1, :cond_0
+ 
+     invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
+ 
+     move-result-object v1
+ 
+     const/4 v2, 0x0
+ 
+     invoke-interface {v1, p1, v2}, Landroid/content/pm/IPackageManager;->getPackageUid(Ljava/lang/String;I)I
+ 
+     move-result v1
+ 
+     invoke-virtual {v0, v1, p1}, Lmiui/security/SecurityManager;->killNativePackageProcesses(ILjava/lang/String;)V
+     :try_end_0
+     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
+ 
+     .end local v0           #sm:Lmiui/security/SecurityManager;
+     :cond_0
+     :goto_0
+     return-void
+ 
+     :catch_0
+     move-exception v1
+ 
+     goto :goto_0
+ .end method
+ 
  .method private final killPackageProcessesLocked(Ljava/lang/String;IIIZZZZLjava/lang/String;)Z
      .locals 14
      .parameter "packageName"
***************
*** 22096,22102 ****
      move-result-object v1
  
      .local v1, context:Landroid/content/Context;
!     const v4, 0x103006b
  
      invoke-virtual {v1, v4}, Landroid/content/Context;->setTheme(I)V
  
--- 22175,22181 ----
      move-result-object v1
  
      .local v1, context:Landroid/content/Context;
!     const v4, 0x60d003a
  
      invoke-virtual {v1, v4}, Landroid/content/Context;->setTheme(I)V
  
***************
*** 31692,31697 ****
--- 31771,31787 ----
      throw v0
  
      :cond_0
+     invoke-direct {p0, p3, p4, p7}, Lcom/android/server/am/ActivityManagerService;->checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;I)Z
+ 
+     move-result v6
+ 
+     if-nez v6, :cond_miui_0
+ 
+     const/4 v6, -0x1
+ 
+     return v6
+ 
+     :cond_miui_0
      monitor-enter p0
  
      :try_start_0
***************
*** 46369,46374 ****
--- 46459,46466 ----
  
      invoke-virtual {v2, v0, v3, v4}, Landroid/os/Handler;->sendMessageDelayed(Landroid/os/Message;J)Z
  
+     goto :goto_miui_0
+     
      const-string v2, "ActivityManager"
  
      const-string v3, "broadcast BOOT_COMPLETED intent"
***************
*** 46389,46394 ****
--- 46481,46487 ----
  
      .restart local v20       #nmsg:Landroid/os/Message;
      :cond_2
+     :goto_miui_0
      const-string v2, "sys.boot_completed"
  
      const-string v3, "1"
***************
*** 46511,46516 ****
--- 46604,46624 ----
      :try_end_0
      .catchall {:try_start_0 .. :try_end_0} :catchall_0
  
+     move-object/from16 v0, p0
+ 
+     iget v2, v0, Lcom/android/server/am/ActivityManagerService;->mFactoryTest:I
+ 
+     const/4 v3, 0x1
+ 
+     if-eq v2, v3, :cond_miui_0
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v2, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+ 
+     invoke-static {v2}, Lcom/android/server/am/ExtraActivityManagerService;->finishBooting(Landroid/content/Context;)V
+ 
+     :cond_miui_0
      :try_start_1
      const-class v2, Lcom/mediatek/common/lowstorage/ILowStorageHandle;
  
***************
*** 48200,48206 ****
      return-object v1
  
      :cond_0
!     const/4 v1, 0x0
  
      goto :goto_0
  
--- 48308,48316 ----
      return-object v1
  
      :cond_0
!     invoke-static {p0, p1}, Lcom/android/server/am/ActivityManagerService$Injector;->getCallingUidPackage(Lcom/android/server/am/ActivityManagerService;Landroid/os/IBinder;)Ljava/lang/String;
! 
!     move-result-object v1
  
      goto :goto_0
  
***************
*** 65752,65757 ****
--- 65862,65878 ----
      invoke-static {v0, v1}, Landroid/util/Slog;->v(Ljava/lang/String;Ljava/lang/String;)I
  
      :cond_1
+     invoke-direct {p0, p2, p3}, Lcom/android/server/am/ActivityManagerService;->checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;)Z
+ 
+     move-result v8
+ 
+     if-nez v8, :cond_miui_0
+ 
+     const/4 v8, 0x0
+ 
+     return-object v8
+ 
+     :cond_miui_0
      monitor-enter p0
  
      :try_start_0
***************
*** 68167,68172 ****
--- 68288,68295 ----
  
      invoke-virtual {v3, v4, v5}, Lcom/android/server/am/PowerOffAlarmUtility;->launchPowrOffAlarm(Ljava/lang/Boolean;Ljava/lang/Boolean;)V
  
+     goto :goto_miui_0
+     
      monitor-exit p0
  
      goto/16 :goto_0
***************
*** 68182,68187 ****
--- 68305,68311 ----
  
      :cond_18
      :try_start_12
+     :goto_miui_0
      const-string v3, "ActivityManager"
  
      const-string v4, "resumeTopActivityLocked enabled"
***************
*** 70417,70422 ****
--- 70541,70552 ----
  
      invoke-direct/range {v2 .. v16}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;Ljava/lang/String;ZZIII)I
  
+     move/from16 v0, v23
+ 
+     move-object/from16 v1, v28
+ 
+     invoke-static {v0, v1}, Landroid/app/MiuiThemeHelper;->handleExtraConfigurationChangesForSystem(ILandroid/content/res/Configuration;)V
+ 
      and-int/lit8 v2, v23, 0x4
  
      if-eqz v2, :cond_e
***************
*** 70460,70465 ****
--- 70590,70597 ----
      invoke-direct/range {v2 .. v16}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;Ljava/lang/String;ZZIII)I
  
      :cond_e
+     goto :goto_miui_0
+     
      const/high16 v2, -0x8000
  
      and-int v2, v2, v23
***************
*** 70520,70525 ****
--- 70652,70658 ----
      .end local v25           #i:I
      .end local v28           #newConfig:Landroid/content/res/Configuration;
      :cond_f
+     :goto_miui_0
      if-eqz v23, :cond_10
  
      if-nez p2, :cond_10
***************
*** 73314,73316 ****
--- 73447,73516 ----
  
      goto :goto_1
  .end method
+ 
+ .method private checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;)Z
+     .locals 2
+     .parameter "service"
+     .parameter "resolvedType"
+ 
+     .prologue
+     iget-boolean v0, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+ 
+     if-eqz v0, :cond_0
+ 
+     iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+ 
+     invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+ 
+     move-result v1
+ 
+     invoke-static {v1}, Landroid/os/UserId;->getUserId(I)I
+ 
+     move-result v1
+ 
+     invoke-static {v0, p1, p2, v1}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Landroid/content/Intent;Ljava/lang/String;I)Z
+ 
+     move-result v0
+ 
+     if-nez v0, :cond_0
+ 
+     const/4 v0, 0x0
+ 
+     :goto_0
+     return v0
+ 
+     :cond_0
+     const/4 v0, 0x1
+ 
+     goto :goto_0
+ .end method
+ 
+ .method private checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;I)Z
+     .locals 1
+     .parameter "service"
+     .parameter "resolvedType"
+     .parameter "userId"
+ 
+     .prologue
+     iget-boolean v0, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+ 
+     if-eqz v0, :cond_0
+ 
+     iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+ 
+     invoke-static {v0, p1, p2, p3}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Landroid/content/Intent;Ljava/lang/String;I)Z
+ 
+     move-result v0
+ 
+     if-nez v0, :cond_0
+ 
+     const/4 v0, 0x0
+ 
+     :goto_0
+     return v0
+ 
+     :cond_0
+     const/4 v0, 0x1
+ 
+     goto :goto_0
+ .end method
