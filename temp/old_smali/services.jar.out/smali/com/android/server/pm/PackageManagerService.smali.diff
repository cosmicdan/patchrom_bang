*** ./smali/com/android/server/pm/PackageManagerService.smali	2014-10-11 10:21:20.192209699 +1100
--- /home/cosmicdan/patchrom_mtk/bang/temp/new_smali/services.jar.out/./smali/com/android/server/pm/PackageManagerService.smali	2014-10-11 10:18:19.092205771 +1100
***************
*** 22,28 ****
          Lcom/android/server/pm/PackageManagerService$ActivityIntentResolver;,
          Lcom/android/server/pm/PackageManagerService$PackageHandler;,
          Lcom/android/server/pm/PackageManagerService$PostInstallData;,
!         Lcom/android/server/pm/PackageManagerService$DefaultContainerConnection;
      }
  .end annotation
  
--- 22,29 ----
          Lcom/android/server/pm/PackageManagerService$ActivityIntentResolver;,
          Lcom/android/server/pm/PackageManagerService$PackageHandler;,
          Lcom/android/server/pm/PackageManagerService$PostInstallData;,
!         Lcom/android/server/pm/PackageManagerService$DefaultContainerConnection;,
!         Lcom/android/server/pm/PackageManagerService$Injector;
      }
  .end annotation
  
***************
*** 1019,1024 ****
--- 1020,1027 ----
  
      invoke-virtual {v2, v3, v4, v5}, Lcom/android/server/pm/Settings;->addSharedUserLPw(Ljava/lang/String;II)Lcom/android/server/pm/SharedUserSetting;
  
+     invoke-static/range {p0 .. p0}, Lcom/android/server/pm/PackageManagerService$Injector;->addMiuiSharedUids(Lcom/android/server/pm/PackageManagerService;)V
+ 
      const-string v2, "debug.separate_processes"
  
      invoke-static {v2}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
***************
*** 1823,1828 ****
--- 1826,1837 ----
  
      move-object/from16 v0, p0
  
+     move-object/from16 v1, v24
+ 
+     invoke-static {v0, v1}, Lcom/android/server/pm/PackageManagerService$Injector;->ignoreMiuiFrameworkRes(Lcom/android/server/pm/PackageManagerService;Ljava/util/HashSet;)V
+ 
+     move-object/from16 v0, p0
+ 
      iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mFrameworkDir:Ljava/io/File;
  
      invoke-virtual {v2}, Ljava/io/File;->list()[Ljava/lang/String;
***************
*** 2503,2509 ****
  
      iget v2, v0, Lcom/android/server/pm/PackageSetting;->pkgFlags:I
  
!     const/high16 v3, 0x4000
  
      and-int/2addr v2, v3
  
--- 2512,2518 ----
  
      iget v2, v0, Lcom/android/server/pm/PackageSetting;->pkgFlags:I
  
!     const/high16 v3, 0x200
  
      and-int/2addr v2, v3
  
***************
*** 2820,2825 ****
--- 2829,2840 ----
  
      move-object/from16 v0, p0
  
+     iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+ 
+     invoke-static {v0, v2}, Lcom/android/server/pm/ExtraPackageManagerServices;->performPreinstallApp(Lcom/android/server/pm/PackageManagerService;Lcom/android/server/pm/Settings;)V
+ 
+     move-object/from16 v0, p0
+ 
      iget-boolean v2, v0, Lcom/android/server/pm/PackageManagerService;->mOnlyCore:Z
  
      if-nez v2, :cond_1c
***************
*** 3355,3360 ****
--- 3370,3377 ----
  
      iput-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mRequiredVerifierPackage:Ljava/lang/String;
  
+     invoke-static {}, Lcom/android/server/pm/ExtraPackageManagerServices;->postScanPackages()V
+ 
      monitor-exit v45
      :try_end_9
      .catchall {:try_start_9 .. :try_end_9} :catchall_0
***************
*** 4089,4094 ****
--- 4106,4177 ----
      return-void
  .end method
  
+ .method private checkInstallerFromXiaomi(I)I
+     .locals 7
+     .parameter "uid"
+ 
+     .prologue
+     const/4 v4, 0x0
+ 
+     const-string v2, "com.android.packageinstaller"
+ 
+     .local v2, INSTALL_FROM_PACKAGEINSTALLER:Ljava/lang/String;
+     const-string v0, "com.xiaomi.gamecenter"
+ 
+     .local v0, INSTALL_FROM_GAMECENTER:Ljava/lang/String;
+     const-string v1, "com.xiaomi.market"
+ 
+     .local v1, INSTALL_FROM_MARKET:Ljava/lang/String;
+     invoke-virtual {p0, p1}, Lcom/android/server/pm/PackageManagerService;->getPackagesForUid(I)[Ljava/lang/String;
+ 
+     move-result-object v3
+ 
+     .local v3, packages:[Ljava/lang/String;
+     if-eqz v3, :cond_1
+ 
+     array-length v5, v3
+ 
+     const/4 v6, 0x1
+ 
+     if-ne v5, v6, :cond_1
+ 
+     const-string v5, "com.android.packageinstaller"
+ 
+     aget-object v6, v3, v4
+ 
+     invoke-virtual {v5, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+ 
+     move-result v5
+ 
+     if-nez v5, :cond_0
+ 
+     const-string v5, "com.xiaomi.gamecenter"
+ 
+     aget-object v6, v3, v4
+ 
+     invoke-virtual {v5, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+ 
+     move-result v5
+ 
+     if-nez v5, :cond_0
+ 
+     const-string v5, "com.xiaomi.market"
+ 
+     aget-object v6, v3, v4
+ 
+     invoke-virtual {v5, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+ 
+     move-result v5
+ 
+     if-eqz v5, :cond_1
+ 
+     :cond_0
+     const/16 v4, 0x100
+ 
+     :cond_1
+     return v4
+ .end method
+ 
  .method private checkPermissionTreeLP(Ljava/lang/String;)Lcom/android/server/pm/BasePermission;
      .locals 4
      .parameter "permName"
***************
*** 4508,4514 ****
      goto/16 :goto_0
  
      :cond_5
!     iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
  
      goto/16 :goto_0
  
--- 4591,4613 ----
      goto/16 :goto_0
  
      :cond_5
!     iget-object v7, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
! 
!     move-object v1, p0
! 
!     move-object/from16 v2, p4
! 
!     move-object v3, p1
! 
!     move-object v4, p2
! 
!     move v5, p3
! 
!     move/from16 v6, p5
! 
!     invoke-static/range {v1 .. v7}, Lcom/android/server/pm/PackageManagerService$Injector;->checkMiuiIntent(Lcom/android/server/pm/PackageManagerService;Ljava/util/List;Landroid/content/Intent;Ljava/lang/String;IILandroid/content/pm/ResolveInfo;)Landroid/content/pm/ResolveInfo;
! 
!     move-result-object v1
  
      goto/16 :goto_0
  
***************
*** 6677,6682 ****
--- 6776,6783 ----
      :try_end_0
      .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
  
+     goto :cond_0
+ 
      const/4 v2, -0x2
  
      :goto_0
***************
*** 9544,9549 ****
--- 9645,9662 ----
  
      .restart local v4       #allowed:Z
      :goto_6
+     move-object/from16 v0, p1
+ 
+     iget-object v0, v0, Landroid/content/pm/PackageParser$Package;->mSignatures:[Landroid/content/pm/Signature;
+ 
+     move-object/from16 v19, v0
+ 
+     invoke-static/range {v19 .. v19}, Lmiui/content/pm/ExtraPackageManager;->isTrustedSystemSignature([Landroid/content/pm/Signature;)Z
+ 
+     move-result v19
+ 
+     or-int v4, v4, v19
+ 
      if-nez v4, :cond_d
  
      iget v0, v6, Lcom/android/server/pm/BasePermission;->protectionLevel:I
***************
*** 10459,10464 ****
--- 10572,10585 ----
      goto :goto_0
  
      :cond_4
+     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+ 
+     iget-object v1, p1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+ 
+     iget-object v2, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+ 
+     invoke-static {v0, v1, v2}, Lcom/android/server/pm/ExtraPackageManagerServices;->postProcessNewInstall(Landroid/content/Context;Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
+ 
      move-object/from16 v0, p5
  
      move-object/from16 v1, p6
***************
*** 15302,15308 ****
  
      move-result v0
  
!     if-nez v0, :cond_4
  
      :cond_3
      :goto_1
--- 15423,15439 ----
  
      move-result v0
  
!     if-eqz v0, :cond_3
! 
!     invoke-virtual {v1}, Ljava/io/File;->getPath()Ljava/lang/String;
! 
!     move-result-object v0
! 
!     invoke-static {v0}, Lcom/android/server/pm/ExtraPackageManagerServices;->ignoreApk(Ljava/lang/String;)Z
! 
!     move-result v0
! 
!     if-eqz v0, :cond_4
  
      :cond_3
      :goto_1
***************
*** 15563,15569 ****
  
      iget v4, v3, Landroid/content/pm/ApplicationInfo;->flags:I
  
!     const/high16 v10, 0x4000
  
      or-int/2addr v4, v10
  
--- 15694,15700 ----
  
      iget v4, v3, Landroid/content/pm/ApplicationInfo;->flags:I
  
!     const/high16 v10, 0x200
  
      or-int/2addr v4, v10
  
***************
*** 15748,15754 ****
  
      iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mResolveActivity:Landroid/content/pm/ActivityInfo;
  
!     const v10, 0x1030302
  
      iput v10, v3, Landroid/content/pm/ActivityInfo;->theme:I
  
--- 15879,15885 ----
  
      iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mResolveActivity:Landroid/content/pm/ActivityInfo;
  
!     const v10, 0x60d003e
  
      iput v10, v3, Landroid/content/pm/ActivityInfo;->theme:I
  
***************
*** 16867,16872 ****
--- 16998,17009 ----
      .end local v25           #i:I
      .end local v49           #renamed:Ljava/lang/String;
      :cond_1c
+     move-object/from16 v0, p1
+ 
+     move-object/from16 v1, v45
+ 
+     invoke-static {v0, v1}, Lcom/android/server/pm/PackageManagerService$Injector;->addMiuiExtendFlags(Landroid/content/pm/PackageParser$Package;Lcom/android/server/pm/PackageSetting;)V
+ 
      move-object/from16 v0, v45
  
      iget-object v3, v0, Lcom/android/server/pm/PackageSetting;->origPackage:Lcom/android/server/pm/PackageSettingBase;
***************
*** 18929,18934 ****
--- 19066,19083 ----
      :goto_17
      move-object/from16 v0, p1
  
+     iget-object v10, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+ 
+     iget-object v11, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+ 
+     invoke-static {v3, v10, v11}, Lcom/android/server/pm/ExtraPackageManagerServices;->blockAutoStartedApp(Landroid/content/Context;Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
+ 
+     move-object/from16 v0, p1
+ 
      iget-object v3, v0, Landroid/content/pm/PackageParser$Package;->providers:Ljava/util/ArrayList;
  
      invoke-virtual {v3}, Ljava/util/ArrayList;->size()I
***************
*** 31948,31954 ****
      :goto_3
      if-eqz v9, :cond_5
  
!     invoke-virtual {v5, v9}, Landroid/content/pm/ParceledListSlice;->append(Landroid/os/Parcelable;)Z
  
      move-result v11
  
--- 32097,32103 ----
      :goto_3
      if-eqz v9, :cond_5
  
!     invoke-static {v5, v9, p1}, Lcom/android/server/pm/PackageManagerService$Injector;->addPackageToSlice(Landroid/content/pm/ParceledListSlice;Landroid/content/pm/PackageInfo;I)Z
  
      move-result v11
  
***************
*** 34511,34516 ****
--- 34660,34671 ----
  
      .local v9, user:Landroid/os/UserHandle;
      :goto_0
+     invoke-direct {p0, v11}, Lcom/android/server/pm/PackageManagerService;->checkInstallerFromXiaomi(I)I
+ 
+     move-result v1
+ 
+     or-int/2addr p3, v1
+ 
      const/16 v1, 0x7d0
  
      if-eq v11, v1, :cond_0
***************
*** 37981,37986 ****
--- 38136,38145 ----
      .local v5, permFile:Ljava/io/File;
      invoke-direct {p0, v5}, Lcom/android/server/pm/PackageManagerService;->readPermissionsFromXml(Ljava/io/File;)V
  
+     iget-object v6, p0, Lcom/android/server/pm/PackageManagerService;->mAvailableFeatures:Ljava/util/HashMap;
+ 
+     invoke-static {v6}, Lcom/android/server/pm/PackageManagerService$Injector;->addAvailableFeatures(Ljava/util/HashMap;)V
+ 
      goto/16 :goto_0
  .end method
  
***************
*** 39213,39224 ****
  
      move-result v0
  
!     if-nez v0, :cond_0
  
      :goto_0
      return-void
  
!     :cond_0
      const/4 v2, 0x0
  
      move-object v0, p0
--- 39372,39390 ----
  
      move-result v0
  
!     if-nez v0, :cond_1
  
+     :cond_0
      :goto_0
      return-void
  
!     :cond_1
!     invoke-static {p0, p1, p2, p3}, Lcom/android/server/pm/PackageManagerService$Injector;->setMiuiExtendFlags(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;II)Z
! 
!     move-result v0
! 
!     if-nez v0, :cond_0
! 
      const/4 v2, 0x0
  
      move-object v0, p0
***************
*** 39996,40001 ****
--- 40162,40171 ----
      :goto_0
      invoke-static {v0}, Landroid/content/pm/PackageParser;->setCompatibilityModeEnabled(Z)V
  
+     iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+ 
+     invoke-static {v1}, Lmiui/provider/ExtraGuard;->init(Landroid/content/Context;)V
+ 
      sget-boolean v7, Lcom/android/server/pm/PackageManagerService;->DEBUG_SETTINGS:Z
  
      if-eqz v7, :cond_0
***************
*** 40451,40453 ****
--- 40621,40749 ----
  
      return-void
  .end method
+ 
+ .method deleteDataPackage(Ljava/lang/String;Z)Z
+     .locals 10
+     .parameter "packageName"
+     .parameter "keepData"
+ 
+     .prologue
+     const/4 v0, 0x1
+ 
+     const/4 v8, 0x0
+ 
+     invoke-static {p1}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
+ 
+     move-result v1
+ 
+     if-eqz v1, :cond_1
+ 
+     :cond_0
+     :goto_0
+     return v8
+ 
+     :cond_1
+     iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mPackages:Ljava/util/HashMap;
+ 
+     monitor-enter v1
+ 
+     :try_start_0
+     iget-object v2, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+ 
+     iget-object v2, v2, Lcom/android/server/pm/Settings;->mPackages:Ljava/util/HashMap;
+ 
+     invoke-virtual {v2, p1}, Ljava/util/HashMap;->get(Ljava/lang/Object;)Ljava/lang/Object;
+ 
+     move-result-object v7
+ 
+     check-cast v7, Lcom/android/server/pm/PackageSetting;
+ 
+     .local v7, ps:Lcom/android/server/pm/PackageSetting;
+     if-nez v7, :cond_2
+ 
+     monitor-exit v1
+ 
+     goto :goto_0
+ 
+     .end local v7           #ps:Lcom/android/server/pm/PackageSetting;
+     :catchall_0
+     move-exception v0
+ 
+     monitor-exit v1
+     :try_end_0
+     .catchall {:try_start_0 .. :try_end_0} :catchall_0
+ 
+     throw v0
+ 
+     .restart local v7       #ps:Lcom/android/server/pm/PackageSetting;
+     :cond_2
+     :try_start_1
+     monitor-exit v1
+     :try_end_1
+     .catchall {:try_start_1 .. :try_end_1} :catchall_0
+ 
+     invoke-static {v7}, Lcom/android/server/pm/PackageManagerService;->isSystemApp(Lcom/android/server/pm/PackageSetting;)Z
+ 
+     move-result v1
+ 
+     if-nez v1, :cond_0
+ 
+     new-instance v5, Lcom/android/server/pm/PackageManagerService$PackageRemovedInfo;
+ 
+     invoke-direct {v5}, Lcom/android/server/pm/PackageManagerService$PackageRemovedInfo;-><init>()V
+ 
+     .local v5, info:Lcom/android/server/pm/PackageManagerService$PackageRemovedInfo;
+     iget-object v9, p0, Lcom/android/server/pm/PackageManagerService;->mInstallLock:Ljava/lang/Object;
+ 
+     monitor-enter v9
+ 
+     const/4 v2, 0x0
+ 
+     const/4 v3, 0x1
+ 
+     const/high16 v1, 0x1
+ 
+     if-eqz p2, :cond_3
+ 
+     move v8, v0
+ 
+     :cond_3
+     or-int v4, v1, v8
+ 
+     const/4 v6, 0x1
+ 
+     move-object v0, p0
+ 
+     move-object v1, p1
+ 
+     :try_start_2
+     invoke-direct/range {v0 .. v6}, Lcom/android/server/pm/PackageManagerService;->deletePackageLI(Ljava/lang/String;Landroid/os/UserHandle;ZILcom/android/server/pm/PackageManagerService$PackageRemovedInfo;Z)Z
+ 
+     move-result v8
+ 
+     .local v8, ret:Z
+     iget-object v0, v5, Lcom/android/server/pm/PackageManagerService$PackageRemovedInfo;->args:Lcom/android/server/pm/PackageManagerService$InstallArgs;
+ 
+     if-eqz v0, :cond_4
+ 
+     iget-object v0, v5, Lcom/android/server/pm/PackageManagerService$PackageRemovedInfo;->args:Lcom/android/server/pm/PackageManagerService$InstallArgs;
+ 
+     const/4 v1, 0x1
+ 
+     invoke-virtual {v0, v1}, Lcom/android/server/pm/PackageManagerService$InstallArgs;->doPostDeleteLI(Z)Z
+ 
+     :cond_4
+     monitor-exit v9
+ 
+     goto :goto_0
+ 
+     .end local v8           #ret:Z
+     :catchall_1
+     move-exception v0
+ 
+     monitor-exit v9
+     :try_end_2
+     .catchall {:try_start_2 .. :try_end_2} :catchall_1
+ 
+     throw v0
+ .end method
